{% extends "base.html" %}

{% block head %}
    <title>聊天管理 - 社交平台</title>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
        }
        
        .chat-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .chat-table th, .chat-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .chat-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        
        .chat-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        
        .btn-edit {
            background-color: #007bff;
            color: white;
        }
        
        .btn-edit:hover {
            background-color: #0056b3;
        }
        
        .btn-delete {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background-color: #c82333;
        }
        
        .btn-add {
            background-color: #28a745;
            color: white;
            padding: 8px 16px;
            margin-bottom: 20px;
        }
        
        .btn-add:hover {
            background-color: #218838;
        }
        
        .search-box {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        
        .search-box input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-right: 10px;
            width: 300px;
        }
        
        .search-box button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .pagination {
            margin-top: 20px;
            text-align: center;
        }
        
        .pagination a {
            display: inline-block;
            padding: 8px 12px;
            margin: 0 4px;
            text-decoration: none;
            background-color: #f8f9fa;
            color: #007bff;
            border-radius: 4px;
        }
        
        .pagination a:hover {
            background-color: #e9ecef;
        }
        
        .pagination .current {
            background-color: #007bff;
            color: white;
        }
        
        @media (max-width: 768px) {
            .chat-table {
                font-size: 0.9em;
            }
            
            .chat-table th, .chat-table td {
                padding: 8px 10px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .btn {
                margin-bottom: 5px;
            }
        }
        
        .message-actions {
            margin-top: 20px;
        }
        
        .message-actions .btn {
            margin-right: 10px;
            margin-bottom: 10px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="admin-container">
        <h1>聊天管理</h1>
        
        <div class="message-actions">
            <button class="btn btn-add" onclick="showCreateRoomModal()">创建聊天室</button>
            <button class="btn btn-add" onclick="clearChatMessages()">清空所有聊天消息</button>
            <button class="btn btn-add" onclick="clearChatRoomMessages()">清空特定聊天室消息</button>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="搜索聊天室名称...">
            <button onclick="searchRooms()">搜索</button>
            <button onclick="clearSearch()">清除</button>
        </div>
        
        <table class="chat-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>名称</th>
                    <th>描述</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="chatTableBody">
                {% for room in rooms %}
                <tr id="room-row-{{ room.id }}">
                    <td>{{ room.id }}</td>
                    <td>{{ room.name }}</td>
                    <td>{{ room.description or '无描述' }}</td>
                    <td class="action-buttons">
                        {% if room.id != 1 %}
                            <button class="btn btn-edit" onclick="editRoom({{ room.id }}, '{{ room.name|e }}', '{{ room.description|e }}')">编辑</button>
                            <button class="btn btn-delete" onclick="deleteRoom({{ room.id }}, '{{ room.name|e }}')">删除</button>
                        {% else %}
                            <span style="color: #6c757d; font-size: 0.9em;">默认聊天室</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- 创建房间模态框 -->
    <div id="createRoomModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:8px; width:400px; max-width:90%;">
            <h3>创建聊天室</h3>
            <form id="createRoomForm">
                <div style="margin-bottom:15px;">
                    <label>名称:</label>
                    <input type="text" id="createRoomName" style="width:100%; padding:8px; margin-top:5px;" required>
                </div>
                <div style="margin-bottom:15px;">
                    <label>描述:</label>
                    <textarea id="createRoomDescription" style="width:100%; padding:8px; margin-top:5px; height:80px;"></textarea>
                </div>
                <div style="text-align:right;">
                    <button type="button" onclick="closeCreateModal()" style="padding:8px 16px; margin-right:10px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">取消</button>
                    <button type="submit" style="padding:8px 16px; background:#28a745; color:white; border:none; border-radius:4px; cursor:pointer;">创建</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 编辑房间模态框 -->
    <div id="editRoomModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:8px; width:400px; max-width:90%;">
            <h3>编辑聊天室</h3>
            <form id="editRoomForm">
                <input type="hidden" id="editRoomId" value="">
                <div style="margin-bottom:15px;">
                    <label>名称:</label>
                    <input type="text" id="editRoomName" style="width:100%; padding:8px; margin-top:5px;" required>
                </div>
                <div style="margin-bottom:15px;">
                    <label>描述:</label>
                    <textarea id="editRoomDescription" style="width:100%; padding:8px; margin-top:5px; height:80px;"></textarea>
                </div>
                <div style="text-align:right;">
                    <button type="button" onclick="closeModal()" style="padding:8px 16px; margin-right:10px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">取消</button>
                    <button type="submit" style="padding:8px 16px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 清空特定聊天室消息模态框 -->
    <div id="clearRoomModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:8px; width:400px; max-width:90%;">
            <h3>清空聊天室消息</h3>
            <div style="margin-bottom:15px;">
                <label>选择聊天室:</label>
                <select id="selectRoom" style="width:100%; padding:8px; margin-top:5px;">
                    <option value="">所有聊天室</option>
                    {% for room in rooms %}
                    <option value="{{ room.id }}">{{ room.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="margin-bottom:15px;">
                <label>清空日期前的消息:</label>
                <input type="date" id="beforeDate" style="width:100%; padding:8px; margin-top:5px;">
                <small style="color:#6c757d; display:block; margin-top:5px;">留空则清空所有消息</small>
            </div>
            <div style="text-align:right;">
                <button type="button" onclick="closeClearRoomModal()" style="padding:8px 16px; margin-right:10px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">取消</button>
                <button type="button" onclick="confirmClearRoomMessages()" style="padding:8px 16px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer;">清空消息</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        // 搜索功能
        function searchRooms() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#chatTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // 清除搜索
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            const rows = document.querySelectorAll('#chatTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
        }
        
        // 监听回车键搜索
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchRooms();
            }
        });
        
        // 显示创建房间模态框
        function showCreateRoomModal() {
            document.getElementById('createRoomName').value = '';
            document.getElementById('createRoomDescription').value = '';
            document.getElementById('createRoomModal').style.display = 'block';
        }
        
        // 关闭创建模态框
        function closeCreateModal() {
            document.getElementById('createRoomModal').style.display = 'none';
        }
        
        // 编辑房间
        function editRoom(roomId, name, description) {
            document.getElementById('editRoomId').value = roomId;
            document.getElementById('editRoomName').value = name;
            document.getElementById('editRoomDescription').value = description || '';
            document.getElementById('editRoomModal').style.display = 'block';
        }
        
        // 删除房间
        function deleteRoom(roomId, roomName) {
            if (!confirm(`确定要删除聊天室 "${roomName}" 吗？此操作不可撤销！`)) {
                return;
            }
            
            fetch(`/api/admin/chat/rooms/${roomId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`room-row-${roomId}`).remove();
                    alert(data.message);
                } else {
                    alert('删除失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                alert('删除失败: ' + error.message);
            });
        }
        
        // 关闭模态框
        function closeModal() {
            document.getElementById('editRoomModal').style.display = 'none';
        }
        
        function closeClearRoomModal() {
            document.getElementById('clearRoomModal').style.display = 'none';
        }
        
        // 保存房间修改
        document.getElementById('editRoomForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const roomId = document.getElementById('editRoomId').value;
            const name = document.getElementById('editRoomName').value;
            const description = document.getElementById('editRoomDescription').value;
            
            fetch(`/api/admin/chat/rooms/${roomId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新页面上的房间信息
                    const row = document.getElementById(`room-row-${roomId}`);
                    row.cells[1].textContent = name;
                    row.cells[2].textContent = description || '无描述';
                    
                    closeModal();
                    alert(data.message);
                } else {
                    alert('操作失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                alert('操作失败: ' + error.message);
            });
        });
        
        // 创建房间
        document.getElementById('createRoomForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('createRoomName').value;
            const description = document.getElementById('createRoomDescription').value;
            
            fetch('/api/admin/chat/rooms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 添加新房间到表格
                    const newRow = document.createElement('tr');
                    newRow.id = `room-row-${data.room.id}`;
                    newRow.innerHTML = `
                        <td>${data.room.id}</td>
                        <td>${data.room.name}</td>
                        <td>${data.room.description || '无描述'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-edit" onclick="editRoom(${data.room.id}, '${data.room.name.replace(/'/g, "\\'")}', '${(data.room.description || '').replace(/'/g, "\\'")}')">编辑</button>
                            <button class="btn btn-delete" onclick="deleteRoom(${data.room.id}, '${data.room.name.replace(/'/g, "\\'")}')">删除</button>
                        </td>
                    `;
                    document.getElementById('chatTableBody').appendChild(newRow);
                    
                    closeCreateModal();
                    alert(data.message);
                } else {
                    alert('操作失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                alert('操作失败: ' + error.message);
            });
        });
        
        // 清空所有聊天消息
        function clearChatMessages() {
            if (!confirm('确定要清空所有聊天消息吗？此操作不可撤销！')) {
                return;
            }
            
            fetch('/api/admin/chat/messages', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                } else {
                    alert('清空失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                alert('清空失败: ' + error.message);
            });
        }
        
        // 清空特定聊天室消息
        function clearChatRoomMessages() {
            document.getElementById('clearRoomModal').style.display = 'block';
        }
        
        // 确认清空特定聊天室消息
        function confirmClearRoomMessages() {
            const roomId = document.getElementById('selectRoom').value;
            const beforeDate = document.getElementById('beforeDate').value;
            
            let url = '/api/admin/chat/messages';
            const params = [];
            if (roomId) params.push(`room_id=${roomId}`);
            if (beforeDate) params.push(`before=${beforeDate}T23:59:59`);
            if (params.length > 0) url += '?' + params.join('&');
            
            if (!confirm('确定要清空选定条件下的聊天消息吗？此操作不可撤销！')) {
                return;
            }
            
            fetch(url, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeClearRoomModal();
                    alert(data.message);
                } else {
                    alert('清空失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                alert('清空失败: ' + error.message);
            });
        }
        
        // 点击模态框外部关闭
        window.onclick = function(event) {
            const createModal = document.getElementById('createRoomModal');
            const editModal = document.getElementById('editRoomModal');
            const clearModal = document.getElementById('clearRoomModal');
            
            if (event.target === createModal) {
                closeCreateModal();
            }
            if (event.target === editModal) {
                closeModal();
            }
            if (event.target === clearModal) {
                closeClearRoomModal();
            }
        }
    </script>
{% endblock %}