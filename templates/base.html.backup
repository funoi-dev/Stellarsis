<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>群星议会</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" 
          crossorigin="anonymous">
    {% block head %}{% endblock %}
</head>
<body>
    <header>
        <div class="container">
            <h1><a href="/">群星议会</a></h1>
            <nav>
                <ul>
                    <li><a href="{{ url_for('chat_index') }}">即时聊天</a></li>
                    <li><a href="{{ url_for('forum_index') }}">贴吧</a></li>
                    {% if current_user.is_authenticated %}
                    <li><a href="{{ url_for('profile') }}">个人中心</a></li>
                    <li><a href="{{ url_for('logout') }}">登出</a></li>
                    {% else %}
                    <li><a href="{{ url_for('login') }}">登录</a></li>
                    {% endif %}
                    {% if current_user.is_authenticated and current_user.id == 1 %}
                    <li><a href="{{ url_for('admin_index') }}">管理面板</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </main>

    <footer>
        <div class="container">
            <p>群星议会 &copy; 2025 | 在线人数: <span id="online-count">加载中...</span></p>
        </div>
    </footer>

    {% block scripts %}
    <!-- 兼容性垫片 -->
    <script>
        // 基础ES5垫片
        if (!Array.prototype.includes) {
            Array.prototype.includes = function(searchElement) {
                return this.indexOf(searchElement) !== -1;
            };
        }
        
        // 确保Promise存在
        if (typeof Promise === 'undefined') {
            window.Promise = function(executor) {
                // 简单的Promise实现，仅用于兼容
                var callbacks = [];
                var value;
                var isResolved = false;
                
                function resolve(val) {
                    if (isResolved) return;
                    isResolved = true;
                    value = val;
                    callbacks.forEach(function(cb) { cb(val); });
                }
                
                try {
                    executor(resolve, function(reason) {
                        console.error("简易Promise拒绝:", reason);
                    });
                } catch (e) {
                    console.error("简易Promise执行错误:", e);
                }
                
                this.then = function(onFulfilled) {
                    return new Promise(function(resolve) {
                        function handleValue(val) {
                            var result = onFulfilled ? onFulfilled(val) : val;
                            resolve(result);
                        }
                        
                        if (isResolved) {
                            setTimeout(function() { handleValue(value); }, 0);
                        } else {
                            callbacks.push(handleValue);
                        }
                    });
                };
            };
        }
        
        // 确保fetch存在
        if (typeof window.fetch === 'undefined') {
            window.fetch = function(url, options) {
                return new Promise(function(resolve, reject) {
                    var xhr = new XMLHttpRequest();
                    xhr.open(options && options.method ? options.method : 'GET', url, true);
                    
                    xhr.onload = function() {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            resolve({
                                ok: true,
                                status: xhr.status,
                                statusText: xhr.statusText,
                                text: function() { return Promise.resolve(xhr.responseText); },
                                json: function() { 
                                    try {
                                        return Promise.resolve(JSON.parse(xhr.responseText));
                                    } catch (e) {
                                        return Promise.reject(e);
                                    }
                                }
                            });
                        } else {
                            reject({
                                status: xhr.status,
                                statusText: xhr.statusText
                            });
                        }
                    };
                    
                    xhr.onerror = function() {
                        reject({ status: 0, statusText: '网络错误' });
                    };
                    
                    if (options && options.headers) {
                        for (var header in options.headers) {
                            xhr.setRequestHeader(header, options.headers[header]);
                        }
                    }
                    
                    xhr.send(options && options.body ? options.body : null);
                });
            };
        }
    </script>
    
    <!-- 动态加载库的函数 -->
    <script>
        function loadScript(src, callback) {
            var script = document.createElement('script');
            script.src = src;
            script.async = false;  // 保持加载顺序
            
            script.onload = function() {
                console.log('已加载:', src);
                if (callback) callback();
            };
            
            script.onerror = function() {
                console.error('加载失败:', src);
                if (callback) callback(new Error('加载失败: ' + src));
            };
            
            document.head.appendChild(script);
        }
        
        function loadStylesheet(href) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = href;
            document.head.appendChild(link);
        }
        
        // 全局渲染函数（将在加载库后定义）
                                window.renderContent = function(content) {
                            try {
                                // 1. 先用marked渲染Markdown
                                let html = marked.parse(content);
                                
                                // 2. 处理行内LaTeX: $
                                html = html.replace(/$([^$]+)$/g, function(match, p1) {
                                    try {
                                        return katex.renderToString(p1, {
                                            throwOnError: false,
                                            displayMode: false
                                        });
                                    } catch (e) {
                                        console.warn('KaTeX渲染失败:', e.message);
                                        return '<span class="katex-error">$' + escapeHtml(p1) + '$</span>';
                                    }
                                });
                                
                                // 3. 处理块级LaTeX: 37(...)37
                                html = html.replace(/$$([^$]+)$$/g, function(match, p1) {
                                    try {
                                        return '<div class="katex-block">' +
                                               katex.renderToString(p1, {
                                                   throwOnError: false,
                                                   displayMode: true
                                               }) +
                                               '</div>';
                                    } catch (e) {
                                        console.warn('KaTeX块级渲染失败:', e.message);
                                        return '<div class="katex-block katex-error">37' + escapeHtml(p1) + '37</div>';
                                    }
                                });
                                
                                // 4. 处理行内LaTeX: \(...\)
                                html = html.replace(/\\((.*?)\\)/g, function(match, p1) {
                                    try {
                                        return katex.renderToString(p1, {
                                            throwOnError: false,
                                            displayMode: false
                                        });
                                    } catch (e) {
                                        console.warn('KaTeX渲染失败:', e.message);
                                        return '<span class="katex-error">\(' + escapeHtml(p1) + '\)</span>';
                                    }
                                });
                                
                                // 5. 处理块级LaTeX: \[...\]
                                html = html.replace(/\\[(.*?)\\]/g, function(match, p1) {
                                    try {
                                        return '<div class="katex-block">' +
                                               katex.renderToString(p1, {
                                                   throwOnError: false,
                                                   displayMode: true
                                               }) +
                                               '</div>';
                                    } catch (e) {
                                        console.warn('KaTeX块级渲染失败:', e.message);
                                        return '<div class="katex-block katex-error">\[' + escapeHtml(p1) + '\]</div>';
                                    }
                                });
                                
                                return html;
                            } catch (e) {
                                console.error('内容渲染失败:', e);
                                // 降级：显示原始内容，但进行HTML转义
                                return '<div class="render-error">' +
                                       escapeHtml(content) +
                                       '</div>';
                            }
                        };;
                            return callback();
                        }
                        
                        // 加载完成，定义渲染函数
                        window.renderContent = function(content) {
                            try {
                                // 1. 先用marked渲染Markdown
                                let html = marked.parse(content);
                                
                                // 2. 处理行内LaTeX: \(...\)
                                html = html.replace(/\\\((.*?)\\\)/g, function(match, p1) {
                                    try {
                                        return katex.renderToString(p1, {
                                            throwOnError: false,
                                            displayMode: false
                                        });
                                    } catch (e) {
                                        console.warn('KaTeX渲染失败:', e.message);
                                        return '<span class="katex-error">\\(' + escapeHtml(p1) + '\\)</span>';
                                    }
                                });
                                
                                // 3. 处理块级LaTeX: \[...\]
                                html = html.replace(/\\\[(.*?)\\\]/g, function(match, p1) {
                                    try {
                                        return '<div class="katex-block">' + 
                                               katex.renderToString(p1, {
                                                   throwOnError: false,
                                                   displayMode: true
                                               }) + 
                                               '</div>';
                                    } catch (e) {
                                        console.warn('KaTeX块级渲染失败:', e.message);
                                        return '<div class="katex-block katex-error">\\[' + escapeHtml(p1) + '\\]</div>';
                                    }
                                });
                                
                                return html;
                            } catch (e) {
                                console.error('内容渲染失败:', e);
                                // 降级：显示原始内容，但进行HTML转义
                                return '<div class="render-error">' + 
                                       escapeHtml(content) + 
                                       '</div>';
                            }
                        };
                        
                        callback();
                    });
                });
            };
            
            // HTML转义函数
            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "<")
                    .replace(/>/g, ">")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
            
            // 尝试加载渲染库
            loadRenderLibs(function(err) {
                if (err) {
                    console.error('渲染库加载失败，将使用纯文本模式:', err);
                    // 定义安全的纯文本渲染函数
                    window.renderContent = function(content) {
                        return '<pre class="plaintext-render">' + 
                               escapeHtml(content) + 
                               '</pre>';
                    };
                }
                
                // 触发自定义事件，通知页面渲染库已就绪
                var event = new Event('renderReady');
                document.dispatchEvent(event);
            });
        });
    </script>
    {% endblock %}
</body>
</html>